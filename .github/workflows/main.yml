name: Deploy EF Azure Database
on:
  push:
    branches: [ develop ]
jobs: 
  az-login-test:
    runs-on: ubuntu-latest
    steps:
      - name : Check Az version before installing
        run: az --version
      - name: Installing Az CLI Edge build 
        run: |
           cd ../..
           CWD="$(pwd)"
           python3 -m venv canary-venv
           . canary-venv/bin/activate
           echo "***********activated virual environment**********" 
           python3 -m pip install --upgrade pip
           echo "***************started installing cli edge build******************"
           pip3 install -q --upgrade --pre azure-cli --extra-index-url https://azurecliprod.blob.core.windows.net/edge --no-cache-dir --upgrade-strategy=eager
           echo "***************installed cli Edge build*******************"    
           echo "$CWD/canary-venv/bin" >> $GITHUB_PATH
           az --version
           az login
      - name: Check out repository
        uses: actions/checkout@v3
      - name: 'Az CLI login with subscription'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENTID }}
          tenant-id: ${{ secrets.AZURE_TENANTID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTIONID }}
      - name: Unchecked Azure services access to database to check authentication
        uses: azure/sql-action@v2
        with:        
          connection-string: ${{ secrets.AZURE_SQL_CONNECTION_STRING }}
          path: './Database.sqlproj'
          action: 'publish'